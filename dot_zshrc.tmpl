# =============================================================================
# XDG Base Directory (fallback if .zshenv not sourced)
# =============================================================================
export XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
export XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
export XDG_CACHE_HOME="${XDG_CACHE_HOME:-$HOME/.cache}"
export XDG_STATE_HOME="${XDG_STATE_HOME:-$HOME/.local/state}"

# =============================================================================
# Terminal compatibility (Ghostty fallback)
# =============================================================================
# Fall back to xterm-256color if terminfo is missing (e.g., SSH to older servers)
if [[ "$TERM" == "xterm-ghostty" ]] && ! infocmp xterm-ghostty &>/dev/null; then
  export TERM=xterm-256color
fi

# =============================================================================
# Instant prompt (show prompt immediately, load rest async)
# =============================================================================
if [[ -r "${XDG_CACHE_HOME}/starship/init.zsh" ]]; then
  source "${XDG_CACHE_HOME}/starship/init.zsh"
fi

# =============================================================================
# Performance flags
# =============================================================================
DISABLE_MAGIC_FUNCTIONS=true
skip_global_compinit=1

# =============================================================================
# mise (runtime version manager) - early activation for tmux
# =============================================================================
# Must be activated before auto_tmux to ensure tmux is in PATH
if command -v mise &>/dev/null; then
  eval "$(mise activate zsh)"
fi

{{ if .auto_tmux_linux -}}
# =============================================================================
# Auto tmux on Linux SSH sessions
# =============================================================================
auto_tmux_linux() {
  # Skip if already in tmux
  [[ -n "$TMUX" ]] && return 0
  # Skip if not interactive
  [[ ! -o interactive ]] && return 0
  # Skip if explicitly disabled
  [[ "${DISABLE_AUTO_TMUX:-0}" = "1" ]] && return 0
  # Skip in CI/Docker
  [[ -n "$CI" || -n "$CONTAINER" || -f /.dockerenv ]] && return 0
  # Only for SSH sessions
  if [[ -n "$SSH_CLIENT" || -n "$SSH_TTY" ]]; then
    if (( $+commands[tmux] )); then
      # Prefer detached sessions, otherwise create new
      local detached
      detached=$(tmux list-sessions -F '#{session_name}:#{session_attached}' 2>/dev/null \
        | grep ':0$' | head -1 | cut -d: -f1)
      if [[ -n "$detached" ]]; then
        exec tmux attach-session -t "$detached"
      else
        exec tmux new-session
      fi
    fi
  fi
}
auto_tmux_linux
{{ end -}}

{{ include "dot_config/zsh/split/plugins.zsh" }}
{{ include "dot_config/zsh/split/options.zsh" }}
{{ include "dot_config/zsh/split/aliases.zsh" }}
{{ include "dot_config/zsh/split/functions.zsh" }}

# =============================================================================
# SSH Agent
# =============================================================================
{{- if eq .chezmoi.os "darwin" }}
# macOS: Use system SSH agent with Keychain integration
if [[ -z "$SSH_AUTH_SOCK" ]]; then
  # Try to get from launchctl first
  local sock
  sock=$(launchctl getenv SSH_AUTH_SOCK)
  
  # Fallback: Find listener socket safely (restricted to current user)
  if [[ ! -S "$sock" ]]; then
    sock=$(find /private/tmp/com.apple.launchd.* -name Listeners -user "$USER" -type s 2>/dev/null | head -1)
  fi

  [[ -S "$sock" ]] && export SSH_AUTH_SOCK="$sock"
fi

# Load keys into agent
ssh-add --apple-load-keychain 2>/dev/null
{{- else }}
# Linux: Use keychain for SSH agent management
if command -v keychain &>/dev/null; then
  local ssh_keys=()
  [[ -f "$HOME/.ssh/id_ed25519" ]] && ssh_keys+=("id_ed25519")
  [[ -f "$HOME/.ssh/id_github" ]] && ssh_keys+=("id_github")
  [[ -f "$HOME/.ssh/id_rsa" ]] && ssh_keys+=("id_rsa")

  if (( ${#ssh_keys[@]} > 0 )); then
    eval "$(keychain --eval --quiet ${ssh_keys[@]})"
  fi
fi
{{- end }}

# =============================================================================
# Local environment variables (not managed by chezmoi)
# =============================================================================
# Priority: .env.local -> .zshrc.local (both are gitignored)

# Machine-specific environment variables
[[ -f "$HOME/.env.local" ]] && source "$HOME/.env.local"

# Machine-specific shell configuration
[[ -f "$HOME/.zshrc.local" ]] && source "$HOME/.zshrc.local"
{{- if .business_use }}

# =============================================================================
# Work Environment
# =============================================================================
# Add work-specific configurations here
{{ end }}
